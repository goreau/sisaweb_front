// directives/EnterToNext.js (O Novo e Simples)

import {
  registerElement,
  unregisterElement,
  focusNext,
} from '../services/general/focusManager.service.js'

function createKeydownHandler(el, binding) {
  // Retorna a funÃ§Ã£o que serÃ¡ executada no evento 'keydown'
  return function (e) {
    if (e.key === 'Enter') {
      e.preventDefault() // Garante que nenhum evento nativo ocorra

      const nextTarget = el.dataset.nextTarget // Valor armazenado no mounted

      if (nextTarget === 'submit-action') {
        const submitButton = el.querySelector('.submit-btn')

        // Se o prÃ³prio elemento for o botÃ£o (para evitar querySelector em si mesmo)
        if (!submitButton && el.matches('.submit-btn')) {
          el.click()
          return
        }

        if (submitButton) {
          submitButton.click() // âœ… Aciona o evento de clique uma vez
          return
        }
      }

      // Se nÃ£o for submit, avanÃ§a o foco
      focusNext(el, nextTarget)
    }
  }
}

export const EnterToNext = {
  mounted(el, binding, vnode) {
    // ðŸ‘ˆ Certifique-se que VNODE estÃ¡ aqui
    const formId = binding.value || 'default-form'
    el.dataset.nextTarget = binding.value

    const target = el // Sempre injeta o EL

    // DEBUG: Verifique se isso estÃ¡ sendo logado. Se for componente, deve ser um Proxy.
    //console.log('Target Registrado:', target)

    registerElement(formId, target)

    el.addEventListener('keydown', (e) => {
      if (e.keyCode === 13) {
        const nextTarget = el.dataset.nextTarget

        if (nextTarget === 'submit-action') {
          const submitButton = el.querySelector('.submit-btn')

          if (submitButton) {
            submitButton.click()
            return
          } else {
            console.warn('Enter-to-Next: BotÃ£o submit interno nÃ£o encontrado.')
          }
        }
        e.preventDefault()
        focusNext(formId, target)
      }
    })

    const handler = createKeydownHandler(el, binding)
    el.__keydownHandler = handler

    // Adiciona o listener
    el.addEventListener('keydown', handler)
  },
  unmounted(el, binding, vnode) {
    const formId = binding.value || 'default-form'
    const target = vnode.component ? vnode.component.proxy : el
    unregisterElement(formId, target)
    //  el.removeEventListener('keydown', () => {})
    if (el.__keydownHandler) {
      el.removeEventListener('keydown', el.__keydownHandler) // âœ… Corrigido
    }
  },
}
